name: Check Fava Updates and Push Docker

on:
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 0 点运行
  workflow_dispatch:  # 允许手动触发

jobs:
  check-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Get latest Fava tag from GitHub (with fallback)
        id: get_latest_tag
        run: |
          # 修复1：增加容错，API 失败时直接终止流程
          RESPONSE=$(curl -s -w "%{http_code}" https://api.github.com/repos/beancount/fava/tags)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          TAG_CONTENT=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: GitHub API 返回状态码 $HTTP_CODE，内容：$TAG_CONTENT"
            exit 1
          fi
          
          # 修复2：兼容带/不带 v 前缀，且过滤非语义化版本的 Tag
          LATEST_TAG=$(echo "$TAG_CONTENT" | jq -r '.[].name | select(test("^v?\\d+\\.\\d+\\.\\d+$")) | sub("^v"; "")' | head -n1)
          
          # 验证版本是否有效
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: 未获取到有效的 Fava 版本号"
            exit 1
          fi
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest Fava tag: $LATEST_TAG"

      - name: Check if version changed (only for schedule trigger)
        id: check_change
        if: github.event_name == 'schedule'
        run: |
          CURRENT_VERSION=""
          if [ -f "FAVA_VERSION" ]; then
            CURRENT_VERSION=$(cat FAVA_VERSION | tr -d ' \n')  # 去除空格/换行
          fi
          
          # 修复4：空版本时仅当远程版本有效才判定变更
          if [ "${{ steps.get_latest_tag.outputs.latest_tag }}" != "$CURRENT_VERSION" ] && [ -n "${{ steps.get_latest_tag.outputs.latest_tag }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update repository (for schedule trigger with version change, or manual trigger)
        if: (github.event_name == 'schedule' && steps.check_change.outputs.changed == 'true') || github.event_name == 'workflow_dispatch'
        run: |
          echo "${{ steps.get_latest_tag.outputs.latest_tag }}" > FAVA_VERSION
          # 修复3：优化正则，匹配任意 fava==xxx 格式（包括无版本、两位/三位版本）
          sed -i -E "s/fava==[^ ]*/fava==${{ steps.get_latest_tag.outputs.latest_tag }}/" Dockerfile
          echo "已将 Dockerfile 中的 Fava 版本更新为 ${{ steps.get_latest_tag.outputs.latest_tag }}"

      - name: Commit and push changes
        if: (github.event_name == 'schedule' && steps.check_change.outputs.changed == 'true') || github.event_name == 'workflow_dispatch'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add FAVA_VERSION Dockerfile
          if git commit -m "Update Fava to ${{ steps.get_latest_tag.outputs.latest_tag }}"; then
            echo "存在文件变更，执行推送操作"
            git push origin main  # 替换为你的分支名（main/master）
          else
            echo "无文件变更，跳过推送"
          fi

      - name: Set up Docker Buildx
        if: (github.event_name == 'schedule' && steps.check_change.outputs.changed == 'true') || github.event_name == 'workflow_dispatch'
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: (github.event_name == 'schedule' && steps.check_change.outputs.changed == 'true') || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        if: (github.event_name == 'schedule' && steps.check_change.outputs.changed == 'true') || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/fava-docker:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/fava-docker:${{ steps.get_latest_tag.outputs.latest_tag }}
